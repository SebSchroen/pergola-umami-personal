version: v1

components:
- name: umami
  docker:
    image: ghcr.io/umami-software/umami:latest
  env:
  - name: DB_HOST
    component-ref: db
  - name: POSTGRES_USER
    config-ref: POSTGRES_USER
  - name: POSTGRES_PASSWORD
    config-ref: POSTGRES_PASSWORD
  - name: POSTGRES_DB
    config-ref: POSTGRES_DB
  - name: DATABASE_URL
    value: postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(DB_HOST):5432/$(POSTGRES_DB)
  - name: APP_SECRET
    config-ref: APP_SECRET
  ports:
  - 3000
  storage:
  - name: storage-data
    path: /var/lib/outline/data
    size: 1Gi
  user: 1000
  ingresses:
  - host: console

- name: db
  docker:
    image: postgres:15-alpine
  env:
  - name: POSTGRES_USER
    config-ref: POSTGRES_USER
  - name: POSTGRES_PASSWORD
    config-ref: POSTGRES_PASSWORD
  - name: POSTGRES_DB
    value: 'umami'
  ports:
  - 5432
  storage:
  - name: database-data
    path: /var/lib/postgresql/data
    size: 1Gi